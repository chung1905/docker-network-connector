#!/usr/bin/env bash
set -e -u -o pipefail

main_con_name=caddy
event_format='{{if .Action}}{{slice .Action 0 1}} {{.Actor.Attributes.name}}{{end}}'
(docker events -f type=network -f event=create -f event=disconnect --format "$event_format") | \
while read -r event; do
	e=${event::1}
	id=${event:2}
	case $e in
		c)
			docker network connect -- "$id" $main_con_name
			echo connect $main_con_name to "$id"
			;;
		d)
			con_name=$(docker network inspect -f "{{ range .Containers }}{{ .Name }}{{ end }}" -- "$id" || echo '')
			if [ "$con_name" == $main_con_name ]
			then
				docker network disconnect -- "$id" $main_con_name || true
				echo disconnect $main_con_name from "$id"
			fi
			;;
		*)
			echo "$event"
	esac
done
